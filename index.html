<!DOCTYPE html>
<html lang="gl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fol e ar · Mapa do Folclore Galego</title>

  <!-- Estilos do proxecto -->
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/map.css" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Paleta e layout base -->
  <style>
    :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box}html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    body{background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--ink)}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(17,24,39,.6);backdrop-filter: blur(6px);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:12px}.brand img{height:36px;border-radius:6px}
    nav.tabs{display:flex;gap:6px}.tab{border:1px solid var(--border);background:#0b1220;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab[aria-selected="true"]{outline:2px solid var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:12px}@media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card .inner{padding:12px}
    .filters .row{display:grid;gap:8px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    select,input,button{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--ink)}
    input[type="search"]{width:100%}
    button.primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);border:none;color:#05202a;font-weight:700}
    .section-title{font-weight:800;margin:0 0 8px}
    .results{max-height:440px;overflow:auto}.list{list-style:none;margin:0;padding:0}
    .list li{display:flex;justify-content:space-between;gap:10px;padding:10px 6px;border-bottom:1px dashed var(--border);cursor:pointer}
    .tag{font-size:12px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;color:#cbd5e1}
    .footer{margin-top:14px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    a{color:var(--accent)}
    #map{height:420px;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
  </style>
</head>
<body>
  <noscript>Esta aplicación precisa JavaScript para funcionar.</noscript>

  <header>
    <div class="brand">
      <img src="assets/logo.png" alt="fol e ar">
      <div>
        <div style="font-weight:800">fol e ar</div>
        <div style="font-size:12px;color:var(--muted)">Mapa do folclore galego</div>
      </div>
    </div>
    <nav class="tabs" role="tablist" aria-label="Vistas">
      <button class="tab" role="tab" aria-selected="true"  data-view="mapa">Mapa</button>
      <button class="tab" role="tab" aria-selected="false" data-view="pezas">Pezas</button>
      <button class="tab" role="tab" aria-selected="false" data-view="coplas">Coplas</button>
    </nav>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Filtros globais -->
      <aside class="card">
        <div class="inner filters">
          <h3 class="section-title">Filtros</h3>

          <!-- BUSCADOR GLOBAL con autocompletado -->
          <div class="row">
            <label for="lugar">Buscar lugar (provincia, comarca, concello ou parroquia)</label>
            <input id="lugar" type="search" autocomplete="off" placeholder="Ex.: A Coruña, Bergantiños, Malpica, San Xoán de Malpica">
            <ul id="lugar-suxest" class="list" style="margin-top:6px;max-height:200px;overflow:auto"></ul>
          </div>

          <!-- Chip de ámbito activo -->
          <div class="row" id="scope-row" style="display:none">
            <div id="scope-chip" class="tag" style="display:inline-flex;align-items:center;gap:8px">
              Ámbito: <span id="scope-label"></span>
              <button id="scope-clear" class="tag" title="Quitar ámbito">✕</button>
            </div>
          </div>

          <!-- Filtro só para PEZAS -->
          <div class="row" data-only="pezas">
            <label for="ritmo">Ritmo</label>
            <select id="ritmo">
              <option value="">Todos</option>
              <option>Muiñeira</option><option>Xota</option><option>Maneo</option>
              <option>Pasodobre</option><option>Valse</option><option>Mazurca</option><option>Polca</option>
            </select>
          </div>

          <!-- Filtro só para COPLAS -->
          <div class="row" data-only="coplas">
            <label for="q">Buscar texto (coplas)</label>
            <input id="q" type="search" placeholder="Ex.: barquiños de velas..." />
          </div>

          <div class="actions">
            <button class="primary" id="apply">Aplicar</button>
            <button id="clear">Limpar</button>
          </div>

          <!-- Suxestións vía Issues (gratis) -->
          <div style="margin-top:8px;font-size:12px;color:var(--muted)">
            + <a href="#" id="suxest">Enviar suxestión</a> ·
            <a href="#" id="engadir">Engadir copla</a>
          </div>
        </div>
      </aside>

      <!-- Vistas -->
      <main>
        <!-- MAPA -->
        <section class="card view" id="view-mapa">
          <div class="inner">
            <h3 class="section-title">Mapa</h3>
            <div id="map"><div class="placeholder">[ Cargando Leaflet... ]</div></div>
            <div class="footer">
              <div>Tiles: OSM / CARTO / Stamen</div>
              <div><a href="#" id="open-parroquia">Abrir parroquia →</a></div>
            </div>
          </div>
        </section>

        <!-- PEZAS -->
        <section class="card view" id="view-pezas" hidden>
          <div class="inner">
            <h3 class="section-title">Pezas</h3>
            <div class="results">
              <ul class="list" id="pezas-list"></ul>
            </div>
          </div>
        </section>

        <!-- COPLAS -->
        <section class="card view" id="view-coplas" hidden>
          <div class="inner">
            <h3 class="section-title">Coplas</h3>
            <div class="results">
              <ul class="list" id="coplas-list"></ul>
            </div>

            <!-- Cesta -->
            <div class="card cesta">
              <div class="inner">
                <strong>Cesta de coplas (<span id="cesta-count">0</span>)</strong>
                <div class="actions" style="margin-top:6px">
                  <button id="cesta-save">Gardar</button>
                  <button id="cesta-clear">Limpar</button>
                  <button class="primary" id="cesta-pdf">Xerar PDF</button>
                </div>
                <div style="font-size:12px;color:var(--muted)">Arrastra para ordenar (TODO).</div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Librarías externas -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- Módulo principal: orquestra as vistas e os filtros -->
  <script type="module">
    import * as mapa     from './js/mapa.js';
    import * as buscador from './js/buscador.js';
    import './js/datos.js';
    import './js/popup.js';
    import './js/utils.js';

    // ---- Tabs (cambian de vista) ----
    const tabs = document.querySelectorAll('.tab');
    const views = {
      mapa: document.getElementById('view-mapa'),
      pezas: document.getElementById('view-pezas'),
      coplas: document.getElementById('view-coplas'),
    };
    function show(view){
      Object.values(views).forEach(v => v.hidden = true);
      views[view].hidden = false;
      tabs.forEach(t => t.setAttribute('aria-selected', t.dataset.view===view));
      document.querySelectorAll('[data-only]').forEach(n => {
        n.style.display = (n.getAttribute('data-only')===view) ? 'grid' : 'none';
      });
    }
    tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.view)));
    show('mapa');

    // ---- Ligazóns Issues ----
    document.getElementById('suxest').href =
      'https://github.com/fol-e-ar/map/issues/new?title=[Suxesti%C3%B3n]&body=Descrici%C3%B3n%3A%0AConcello%2FParroquia%3A%0AEnlace%20(se%20hai)%3A';
    document.getElementById('engadir').href =
      'https://github.com/fol-e-ar/map/issues/new?title=[Copla]%20T%C3%ADtulo&body=Localizaci%C3%B3n%20(c%C3%B3digo)%3A%0A%0ATexto%3A%0A%0AFonte%3A';

    // ---- Estado global de ámbito ----
    let currentScope = ''; // prov:.. | com:.. | con:.. | par:..
    const scopeRow   = document.getElementById('scope-row');
    const scopeLabel = document.getElementById('scope-label');
    const scopeClear = document.getElementById('scope-clear');

    function emitFiltersChange({scope, ritmo, q}){
      const detail = { scope: scope || '', ritmo: ritmo || '', q: q || '' };
      document.dispatchEvent(new CustomEvent('filters:change', { detail }));
      if (typeof mapa.onFiltersChange === 'function') mapa.onFiltersChange(detail);
    }

    function setScope(scope, labelText){
      currentScope = scope || '';
      if (currentScope) {
        scopeLabel.textContent = labelText || currentScope;
        scopeRow.style.display = 'grid';
      } else {
        scopeRow.style.display = 'none';
      }
      emitFiltersChange({ scope: currentScope, ritmo: ritmoEl?.value || '', q: qEl?.value || '' });
    }

    scopeClear.addEventListener('click', () => setScope('', ''));

    // ---- Inicialización de vistas ----
    if (typeof mapa.initMapa === 'function') mapa.initMapa({ mapContainerId: 'map' });
    if (typeof buscador.initBuscador === 'function') {
      buscador.initBuscador({ pezasListId: 'pezas-list', coplasListId: 'coplas-list', cestaCountId: 'cesta-count' });
    }

    // ---- Inputs de filtro restantes ----
    const ritmoEl = document.getElementById('ritmo');
    const qEl     = document.getElementById('q');

    document.getElementById('apply').addEventListener('click', () => {
      emitFiltersChange({ scope: currentScope, ritmo: ritmoEl?.value || '', q: qEl?.value || '' });
    });

    document.getElementById('clear').addEventListener('click', () => {
      if (ritmoEl) ritmoEl.value = '';
      if (qEl) qEl.value = '';
      setScope('', '');
    });

    // ---- Dende o mapa → pezas dunha parroquia ----
    document.addEventListener('map:open-parroquia', (e) => {
      const { parroquiaId, label } = e.detail || {};
      if (!parroquiaId) return;
      setScope(`par:${parroquiaId}`, label || `Parroquia ${parroquiaId}`);
      show('pezas');
    });

    // ---- Autocompletado: set scope + cambiar vista ----
    document.addEventListener('ui:set-scope', (e) => {
      const { scope, label } = e.detail || {};
      setScope(scope, label);
      document.dispatchEvent(new CustomEvent('ui:switch-view', { detail: { view: 'pezas' }}));
    });

    // ---- Cambiar de vista (atajo) ----
    document.addEventListener('ui:switch-view', (e) => {
      const view = e.detail?.view;
      if (!view) return;
      const btn = document.querySelector(`.tab[data-view="${view}"]`);
      btn?.click();
    });
  </script>
</body>
</html>
